#!/bin/sh

SCRIPT_PATH=$(temp="$(realpath $0)" && dirname "$temp")

OS_FILES="main.c"
OS_BUILD_DIR="$SCRIPT_PATH/build/os-rv32i"
OS_SOURCE_DIR="$SCRIPT_PATH/os"
LINK_SCRIPT="$OS_SOURCE_DIR/link.lds"
OUTPUT_NAME="os"
STDINCLUDE_PATH=$OS_SOURCE_DIR/stdinclude
STDLIB_IN_PATH=$OS_SOURCE_DIR/stdlib
STDLIB_OUT_PATH=$OS_BUILD_DIR/stdlib
ZIG_OPTS="-target riscv32-freestanding-none -mcpu generic_rv32 -O ReleaseFast -fomit-frame-pointer --strip -fsingle-threaded -I${STDINCLUDE_PATH}"
LD_OPTS="-nostdlib -T $LINK_SCRIPT"

SRAM_PATH="${SCRIPT_PATH}/lua/sram.dat"

#set up toolchain environment
LD="ld.lld"
OBJCOPY="llvm-objcopy"

rm -rf "$OS_BUILD_DIR"
mkdir -p "$OS_BUILD_DIR"
mkdir -p "$STDLIB_OUT_PATH"

PREPROCESS="zig cc -E -"
COMPILE="zig build-obj $ZIG_OPTS"

OBJECT_FILES=""

echo stdlib:
for fname in $STDLIB_IN_PATH/*
do
    bname=$(basename "$fname")
    pname=$STDLIB_OUT_PATH/$bname
    oname="$STDLIB_OUT_PATH/${bname%.*}.o"
    echo "process: $fname"
    $PREPROCESS < $fname > $pname
    echo "compile: $pname"
    $COMPILE -femit-bin="${oname}" ${pname}

    OBJECT_FILES="${oname} $OBJECT_FILES"
done
echo app:
for fname in $OS_FILES
do
    dname=${OS_BUILD_DIR}/${fname%.*}
    fname="${OS_SOURCE_DIR}/${fname}"
    echo "compile: $fname"
    $COMPILE -femit-bin="${dname}.o" ${fname}
    OBJECT_FILES="${OBJECT_FILES} ${dname}.o"
done

OUTPUT_ELF_PATH="${OS_BUILD_DIR}/${OUTPUT_NAME}"
echo "link:    ${OUTPUT_ELF_PATH}"
$LD $LD_OPTS $OBJECT_FILES -o $OUTPUT_ELF_PATH

OUTPUT_BIN_PATH=${OUTPUT_ELF_PATH}.bin

echo "export:  ${OUTPUT_BIN_PATH}"
$OBJCOPY -O binary "${OUTPUT_ELF_PATH}" ${OUTPUT_BIN_PATH}

echo "replace: ${SRAM_PATH}"
rm -rf $SRAM_PATH
cp "$OUTPUT_BIN_PATH" "$SRAM_PATH"
